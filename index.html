<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carte – Suivi grévistes</title>

  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    h1 { text-align:center; margin:18px 0; }

    .layout{
      display:flex; gap:12px; max-width:1500px; margin:0 auto 30px;
      padding:0 10px; align-items:flex-start;
    }

    .sidebar{
      width:380px; background:#fff; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.12); padding:12px;
    }
    .sidebar h2{ margin:0 0 10px; font-size:18px; }
    .sidebar .small{ font-size:12px; color:#666; margin:0 0 10px; }

    .controls{ display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    select{
      flex:1; padding:8px 10px; border-radius:10px; border:1px solid #ddd;
      font-size:14px;
    }
    .refresh-btn{
      padding:8px 10px; border-radius:10px; border:1px solid #ddd;
      background:#fafafa; cursor:pointer;
    }

    .zone-summary{
      border:1px solid #eee; border-radius:10px; padding:10px;
      background:#fafafa; margin-bottom:10px;
    }
    .zone-summary .title{ font-weight:700; margin-bottom:4px; }
    .zone-summary .stat{ font-size:13px; color:#333; }

    .results-list{
      display:flex; flex-direction:column; gap:10px;
      max-height: calc(100vh - 240px); overflow:auto; padding-right:4px;
    }

    .row-card{
      border:1px solid #eee; border-radius:12px; padding:10px;
      background:#fff;
    }
    .row-top{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      margin-bottom:8px;
    }
    .row-title{ font-weight:700; font-size:13px; }
    .row-id{ font-size:11px; color:#777; }

    .grid{
      display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;
      margin-bottom:10px;
    }
    .field label{ display:block; font-size:11px; color:#666; margin-bottom:4px; }
    .field input{
      width:100%; padding:8px 10px; border-radius:10px;
      border:1px solid #ddd; font-size:13px;
    }

    .row-actions{ display:flex; gap:8px; justify-content:flex-end; }
    .btn{
      padding:8px 10px; border-radius:10px; border:1px solid #ddd;
      cursor:pointer; font-size:13px; background:#fafafa;
    }
    .btn-primary{ background:#800080; color:#fff; border-color:#800080; }
    .btn-danger{ background:#fff0f0; border-color:#ffb3b3; color:#b00000; }

    .empty{
      padding:10px; border:1px dashed #ddd; border-radius:10px;
      background:#fafafa; color:#666; font-size:13px;
    }

    /* CARTE */
    .map-container{
      position:relative; flex: 1; max-width: 1100px;
      background:#fff; border-radius:12px; overflow:hidden;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .map-container img{ width:100%; display:block; }

    /* Hotspots invisibles mais cliquables */
    .hotspot{
      position:absolute; width:22px; height:22px; border-radius:50%;
      cursor:pointer; transform: translate(-50%, -50%);
      background: transparent; border: none;
    }

    /* MODALE */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.4);
      display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .modal{
      background:#fff; border-radius:12px; max-width:520px; width:95%;
      padding:18px 20px; box-shadow:0 6px 20px rgba(0,0,0,.3);
    }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; }
    .modal-title{ font-size:1.15rem; font-weight:700; }
    .close-btn{ background:none; border:none; font-size:1.6rem; cursor:pointer; }

    table{ border-collapse:collapse; width:100%; margin-top:10px; }
    th,td{ border:1px solid #ddd; padding:7px 8px; font-size:.95rem; }
    th{ background:#f0e6f5; text-align:left; }
    .modal input{ width:100%; border:none; outline:none; background:transparent; font-size:.95rem; }

    .modal-footer{ margin-top:12px; text-align:right; }
    .btn2{ padding:8px 14px; border-radius:10px; border:none; cursor:pointer; font-size:.95rem; }
    .btn-secondary2{ background:#e0e0e0; margin-right:6px; }
    .btn-primary2{ background:#800080; color:#fff; }
  </style>
</head>

<body>

  <h1>Carte – Suivi grévistes</h1>

  <div class="layout">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <h2>Résultats</h2>
      <p class="small">Choisis une zone pour voir / modifier / supprimer les équipes.</p>

      <div class="controls">
        <select id="zoneSelect"></select>
        <button class="refresh-btn" id="refreshBtn">↻</button>
      </div>

      <div class="zone-summary" id="zoneSummary" style="display:none;">
        <div class="title" id="zoneTitle"></div>
        <div class="stat" id="zoneStatLine"></div>
      </div>

      <div id="resultsList" class="results-list"></div>
    </div>

    <!-- MAP -->
    <div class="map-container" id="mapContainer">
      <img src="carte-zones-production.png" alt="Carte des zones">

      <!-- OUEST -->
      <div class="hotspot" data-zone="INFRAPÔLE BRETAGNE" style="left:31%; top:33%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE PAYS DE LOIRE" style="left:31%; top:43%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE INDRE LIMOUSIN" style="left:45%; top:58%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE AQUITAINE" style="left:35%; top:65%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE CENTRE" style="left:43%; top:42%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE LGV ATLANTIQUE" style="left:44%; top:37%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE POITOU CHARENTES" style="left:41%; top:50%;"></div>

      <!-- SUD -->
      <div class="hotspot" data-zone="INFRAPÔLE MIDI-PYRÉNÉES" style="left:46%; top:80%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE LANGUEDOC-ROUSSILLON" style="left:57%; top:81%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE PACA" style="left:67%; top:83%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE LGV SEE" style="left:62%; top:59%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE ALPES" style="left:68%; top:60%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE RHODANIEN" style="left:64%; top:55%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE AUVERGNE-NIVERNAIS" style="left:54%; top:58%;"></div>

      <!-- EST -->
      <div class="hotspot" data-zone="INFRAPÔLE BOURGOGNE FRANCHE-COMTÉ" style="left:63%; top:43%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE RHENAN" style="left:75%; top:30%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE EST EUROPÉEN" style="left:66.5%; top:26.5%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE LORRAINE" style="left:68%; top:22.2%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE CHAMPAGNE ARDENNE" style="left:58%; top:23%;"></div>

      <!-- NORD -->
      <div class="hotspot" data-zone="INFRAPÔLE HAUTE PICARDIE" style="left:55%; top:18%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE NORD EUROPÉEN" style="left:55%; top:12%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE NORD PAS DE CALAIS" style="left:51%; top:10%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE NORD NORMANDIE" style="left:43%; top:24%;"></div>
    </div>
  </div>

  <!-- MODALE SAISIE -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Ajouter une équipe – <span id="zoneName"></span></div>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>

      <table>
        <tr><th>Champ</th><th>Valeur</th></tr>
        <tr>
          <td>Nom équipe</td>
          <td><input type="text" id="champEquipe" placeholder="Ex: Équipe A"></td>
        </tr>
        <tr>
          <td>% gréviste agent</td>
          <td><input type="number" id="champGrevisteAgent" min="0" max="100" step="1" placeholder="0-100"></td>
        </tr>
        <tr>
          <td>% gréviste encadrement</td>
          <td><input type="number" id="champGrevisteEncadrement" min="0" max="100" step="1" placeholder="0-100"></td>
        </tr>
      </table>

      <div class="modal-footer">
        <button class="btn2 btn-secondary2" id="cancelBtn">Fermer</button>
        <button class="btn2 btn-primary2" id="saveBtn">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- MOT DE PASSE SIMPLE -->
  <script>
    const PASSWORD = "CTS CARTE"; // <-- change ici
    const userPass = prompt("Mot de passe requis :");
    if (userPass !== PASSWORD) {
      alert("Accès refusé");
      document.body.innerHTML = "<h2 style='text-align:center;margin-top:40px'>Accès refusé</h2>";
      throw new Error("Accès refusé");
    }
  </script>

  <script>
    // ✅ URL de ton Apps Script déployé
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwd7Z7Fq_2_dSntYK_lp1fGdXwLrGEpW1cbJyc-vjZNCFtozP2Pn15Tp2UA2CuWJXFbww/exec";

    // DOM
    const zoneSelect = document.getElementById("zoneSelect");
    const refreshBtn = document.getElementById("refreshBtn");
    const resultsList = document.getElementById("resultsList");

    const zoneSummary = document.getElementById("zoneSummary");
    const zoneTitle = document.getElementById("zoneTitle");
    const zoneStatLine = document.getElementById("zoneStatLine");

    const modalBackdrop = document.getElementById('modalBackdrop');
    const zoneNameSpan = document.getElementById('zoneName');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');

    // Données en mémoire
    // apiData = { rows: [{id,zone,equipe,agent,encad,...}], byZone: { zone:{sumA,sumE,count} } }
    let apiData = { rows: [], byZone: {} };

    // Zones (depuis tes hotspots pour remplir la liste)
    const HOTSPOT_ZONES = Array.from(document.querySelectorAll(".hotspot"))
      .map(h => h.getAttribute("data-zone"))
      .filter(Boolean);

    function closeModal(){ modalBackdrop.style.display = 'none'; }
    closeModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });

    // Clic sur carte => ouvrir modal + sélectionner zone dans menu
    document.querySelectorAll(".hotspot").forEach(h => {
      h.addEventListener("click", () => {
        const z = h.getAttribute("data-zone");
        zoneSelect.value = z;
        onZoneChanged();
        zoneNameSpan.textContent = z;
        modalBackdrop.style.display = "flex";
      });
    });

    // Utilitaires
    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function computeZoneSummary(zone){
      const z = apiData.byZone[zone];
      if (!z || !z.count) return null;
      const avgA = Math.round((z.sumA / z.count) * 10) / 10;
      const avgE = Math.round((z.sumE / z.count) * 10) / 10;
      return { count: z.count, avgA, avgE };
    }

    function fillZoneSelect(){
      zoneSelect.innerHTML = "";
      const zones = Array.from(new Set(HOTSPOT_ZONES)).sort((a,b)=>a.localeCompare(b,"fr"));

      zones.forEach(z => {
        const opt = document.createElement("option");
        opt.value = z;
        opt.textContent = z;
        zoneSelect.appendChild(opt);
      });

      // sélection par défaut
      if (zones.length) zoneSelect.value = zones[0];
    }

    function renderZoneSummary(zone){
      const s = computeZoneSummary(zone);
      if (!s) {
        zoneSummary.style.display = "none";
        return;
      }
      zoneSummary.style.display = "block";
      zoneTitle.textContent = zone;
      zoneStatLine.textContent = `${s.count} équipe(s) – Moy ${s.avgA}% A / ${s.avgE}% E`;
    }

    function renderRowsForZone(zone){
      resultsList.innerHTML = "";

      const rows = apiData.rows
        .filter(r => r.zone === zone)
        .sort((a,b)=> String(a.equipe).localeCompare(String(b.equipe), "fr"));

      if (!rows.length){
        resultsList.innerHTML = `<div class="empty">Aucune équipe enregistrée pour cette zone.</div>`;
        return;
      }

      rows.forEach(r => {
        const card = document.createElement("div");
        card.className = "row-card";
        card.dataset.id = r.id;

        card.innerHTML = `
          <div class="row-top">
            <div>
              <div class="row-title">${esc(r.equipe)}</div>
              <div class="row-id">ID: ${esc(r.id)}</div>
            </div>
            <div style="font-size:12px;color:#666;text-align:right;">
              ${esc(r.zone)}
            </div>
          </div>

          <div class="grid">
            <div class="field">
              <label>Nom équipe</label>
              <input type="text" value="${esc(r.equipe)}" data-field="equipe">
            </div>
            <div class="field">
              <label>% agent</label>
              <input type="number" min="0" max="100" step="1" value="${esc(r.agent)}" data-field="agent">
            </div>
            <div class="field">
              <label>% encadrement</label>
              <input type="number" min="0" max="100" step="1" value="${esc(r.encad)}" data-field="encad">
            </div>
          </div>

          <div class="row-actions">
            <button class="btn btn-primary" data-action="save">Modifier</button>
            <button class="btn btn-danger" data-action="delete">Supprimer</button>
          </div>
        `;

        // Actions
        card.querySelector('[data-action="save"]').addEventListener("click", () => {
          const equipe = card.querySelector('[data-field="equipe"]').value.trim();
          const agent = Number(card.querySelector('[data-field="agent"]').value);
          const encad = Number(card.querySelector('[data-field="encad"]').value);

          if (!equipe) return alert("Nom équipe manquant.");
          if (Number.isNaN(agent) || Number.isNaN(encad)) return alert("Pourcentages invalides.");

          apiUpdate(r.id, equipe, agent, encad);
        });

        card.querySelector('[data-action="delete"]').addEventListener("click", () => {
          if (!confirm("Supprimer cette ligne ?")) return;
          apiDelete(r.id);
        });

        resultsList.appendChild(card);
      });
    }

    function onZoneChanged(){
      const zone = zoneSelect.value;
      renderZoneSummary(zone);
      renderRowsForZone(zone);
    }

    zoneSelect.addEventListener("change", onZoneChanged);

    // --- APPELS API via JSONP (compat GitHub Pages) ---
    function jsonp(url, cbName){
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        const cleanup = () => { if (s.parentNode) s.parentNode.removeChild(s); };

        window[cbName] = (payload) => { cleanup(); resolve(payload); };
        s.onerror = () => { cleanup(); reject(new Error("JSONP error")); };
        s.src = url;
        document.body.appendChild(s);
      });
    }

    async function apiList(){
      const cb = "cb_list_" + Date.now();
      const url = `${SCRIPT_URL}?callback=${cb}&action=list&ts=${Date.now()}`;
      const res = await jsonp(url, cb);
      if (!res.ok) throw new Error(res.error || "API list error");
      apiData = res.data;
      onZoneChanged();
    }

    async function apiUpdate(id, equipe, agent, encad){
      const cb = "cb_upd_" + Date.now();
      const url = `${SCRIPT_URL}?callback=${cb}&action=update&id=${encodeURIComponent(id)}&equipe=${encodeURIComponent(equipe)}&agent=${encodeURIComponent(agent)}&encad=${encodeURIComponent(encad)}&ts=${Date.now()}`;
      const res = await jsonp(url, cb);
      if (!res.ok) return alert("Erreur update: " + (res.error || ""));
      apiData = res.data;
      onZoneChanged();
      alert("OK : ligne modifiée");
    }

    async function apiDelete(id){
      const cb = "cb_del_" + Date.now();
      const url = `${SCRIPT_URL}?callback=${cb}&action=delete&id=${encodeURIComponent(id)}&ts=${Date.now()}`;
      const res = await jsonp(url, cb);
      if (!res.ok) return alert("Erreur delete: " + (res.error || ""));
      apiData = res.data;
      onZoneChanged();
      alert("OK : ligne supprimée");
    }

    refreshBtn.addEventListener("click", () => {
      apiList().catch(err => {
        console.error(err);
        alert("Impossible de recharger. Vérifie Apps Script / déploiement.");
      });
    });

    // --- AJOUT via POST (modale) ---
    saveBtn.addEventListener("click", async () => {
      const zone = zoneSelect.value;
      const equipe = document.getElementById("champEquipe").value.trim();
      const agentStr = document.getElementById("champGrevisteAgent").value;
      const encadStr = document.getElementById("champGrevisteEncadrement").value;

      if (!equipe) return alert("Merci de saisir le nom d’équipe.");
      if (agentStr === "" || encadStr === "") return alert("Merci de saisir les deux pourcentages.");

      const agent = Number(agentStr);
      const encad = Number(encadStr);
      if (Number.isNaN(agent) || Number.isNaN(encad)) return alert("Pourcentages invalides.");

      const data = { zone, equipe, grevisteAgent: agent, grevisteEncadrement: encad };

      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        closeModal();
        document.getElementById('champEquipe').value = "";
        document.getElementById('champGrevisteAgent').value = "";
        document.getElementById('champGrevisteEncadrement').value = "";

        // Recharger depuis le sheet (pour récupérer le nouvel ID créé côté Apps Script)
        await apiList();
        alert("OK : équipe ajoutée");
      } catch (err) {
        console.error(err);
        alert("Erreur d'envoi. Vérifie le déploiement Apps Script.");
      }
    });

    // Init
    fillZoneSelect();
    zoneNameSpan.textContent = zoneSelect.value;

    // Charger les lignes au démarrage
    apiList().catch(err => {
      console.error(err);
      resultsList.innerHTML = `<div class="empty">Impossible de charger les données (API). Vérifie Apps Script (doGet action=list) et le déploiement.</div>`;
    });
  </script>
</body>
</html>