<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte – Suivi grévistes</title>

  <!-- Important si ton repo s'appelle carte-greviste -->
  <base href="/carte-greviste/">

  <style>
    :root{
      --bg:#f6f6f7; --card:#fff; --border:#e6e6e9; --text:#111; --muted:#666;
      --accent:#7a1fa2; --danger:#d9363e; --shadow:0 6px 20px rgba(0,0,0,.06); --r:14px;
      --font:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:var(--font);color:var(--text)}
    header{padding:18px 22px;font-weight:800;font-size:34px;text-align:center}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:0 16px 16px;align-items:start}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;max-height:calc(100vh - 120px);overflow:auto}
    .panel h2{margin:0 0 8px;font-size:22px}
    .hint{color:var(--muted);font-size:13px;margin:0 0 10px}
    .row{display:flex;gap:10px;align-items:center}
    select, input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-accent{background:var(--accent);color:#fff}
    .btn-ghost{background:#fff;border:1px solid var(--border)}
    .btn-danger{background:#fff;border:1px solid #f1b2b5;color:var(--danger)}
    .btn-sm{padding:8px 12px}
    .resultsTitle{margin:12px 0 6px;font-weight:900;font-size:18px}
    .zoneMeta{color:var(--muted);font-size:13px;margin-bottom:10px}
    .card{border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px;background:#fff}
    .cardTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .teamName{font-weight:900}
    .small{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:8px}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .mapWrap{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:12px}
    .mapContainer{position:relative;max-width:1100px;margin:0 auto}
    .mapContainer img{width:100%;height:auto;display:block;border-radius:12px}

    /* hotspots invisibles */
    .hotspot{
      position:absolute;width:26px;height:26px;border-radius:50%;
      transform:translate(-50%,-50%);
      background:transparent; opacity:0; cursor:pointer;
    }

    /* modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal{width:min(520px,96vw);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.20);border:1px solid var(--border)}
    .modalHeader{display:flex;justify-content:space-between;align-items:center;padding:14px 14px 10px;border-bottom:1px solid var(--border)}
    .modalHeader b{font-size:18px}
    .closeX{font-size:22px;border:0;background:transparent;cursor:pointer}
    .modalBody{padding:14px}
    .modalFooter{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border)}
    .errorBox{margin-top:10px;color:var(--danger);font-weight:800;font-size:13px}

    /* password overlay */
    .gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.40);z-index:10000;padding:16px}
    .gateCard{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.20);padding:18px;max-width:420px;width:100%}
    .gateTitle{font-weight:900;font-size:20px;margin:0 0 6px}
    .gateHint{color:var(--muted);font-size:13px;margin:0 0 12px}
  </style>
</head>

<body>
<header>Carte – Suivi grévistes</header>

<!-- PASSWORD GATE -->
<div class="gate" id="gate">
  <div class="gateCard">
    <p class="gateTitle">Accès protégé</p>
    <p class="gateHint">Entre le mot de passe pour accéder à la carte.</p>
    <div class="row">
      <input id="pwInput" type="password" placeholder="Mot de passe">
      <button class="btn btn-accent btn-sm" id="pwBtn">OK</button>
    </div>
    <div class="errorBox" id="pwErr" style="display:none;"></div>
  </div>
</div>

<div class="layout" id="app" style="display:none;">
  <aside class="panel">
    <h2>Résultats</h2>
    <p class="hint">Choisis une zone pour voir / modifier / supprimer les équipes.</p>

    <div class="row">
      <select id="zoneSelect"></select>
      <button class="btn btn-ghost btn-sm" id="refreshBtn" title="Rafraîchir">↻</button>
    </div>

    <div class="resultsTitle" id="zoneTitle"></div>
    <div class="zoneMeta" id="zoneMeta"></div>

    <div id="resultsList"></div>
  </aside>

  <main class="mapWrap">
    <div class="mapContainer" id="mapContainer">
      <img src="carte-zones-production.png" alt="Carte des zones">

      <!-- OUEST -->
      <div class="hotspot" data-zone="INFRAPÔLE BRETAGNE" style="left:31%; top:33%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE PAYS DE LOIRE" style="left:31%; top:43%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE INDRE LIMOUSIN" style="left:45%; top:58%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE AQUITAINE" style="left:35%; top:65%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE CENTRE" style="left:43%; top:42%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE LGV ATLANTIQUE" style="left:44%; top:37%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE POITOU CHARENTES" style="left:41%; top:50%;"></div>

      <!-- SUD -->
      <div class="hotspot" data-zone="INFRAPÔLE MIDI-PYRÉNÉES" style="left:46%; top:80%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE LANGUEDOC-ROUSSILLON" style="left:57%; top:81%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE PACA" style="left:67%; top:83%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE LGV SEE" style="left:62%; top:59%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE ALPES" style="left:68%; top:60%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE RHODANIEN" style="left:64%; top:55%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE AUVERGNE-NIVERNAIS" style="left:54%; top:58%;"></div>

      <!-- EST -->
      <div class="hotspot" data-zone="INFRAPÔLE BOURGOGNE FRANCHE-COMTÉ" style="left:63%; top:43%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE RHENAN" style="left:75%; top:30%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE EST EUROPÉEN" style="left:66.5%; top:26.5%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE LORRAINE" style="left:68%; top:22.2%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE CHAMPAGNE ARDENNE" style="left:58%; top:23%;"></div>

      <!-- NORD -->
      <div class="hotspot" data-zone="INFRAPÔLE HAUTE PICARDIE" style="left:55%; top:18%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE NORD EUROPÉEN" style="left:55%; top:12%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE NORD PAS DE CALAIS" style="left:51%; top:10%;"></div>
      <div class="hotspot" data-zone="INFRAPÔLE NORD NORMANDIE" style="left:43%; top:24%;"></div>
    </div>
  </main>
</div>

<!-- MODAL ADD -->
<div class="backdrop" id="backdrop">
  <div class="modal">
    <div class="modalHeader">
      <div><b>Ajouter une équipe</b><div class="small">Zone : <span id="modalZone"></span></div></div>
      <button class="closeX" id="closeModal">×</button>
    </div>
    <div class="modalBody">
      <div class="grid">
        <div><div class="small">Nom équipe</div><input id="mEquipe" placeholder="Ex: Équipe A"></div>
        <div><div class="small">% agent</div><input id="mAgent" type="number" min="0" max="100" step="1"></div>
        <div><div class="small">% encadrement</div><input id="mEncad" type="number" min="0" max="100" step="1"></div>
      </div>
      <div class="errorBox" id="modalErr" style="display:none;"></div>
    </div>
    <div class="modalFooter">
      <button class="btn btn-ghost" id="cancelModal">Annuler</button>
      <button class="btn btn-accent" id="saveModal">Enregistrer</button>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const PASSWORD = "CTS CARTE";

  // Mets TON URL /exec
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLA0xAIii_5bBm5ssubHTlA6UnmvLBgqOftWsgKUB6e4ZKDviRQw92L6LbecxgdK8Pxg/exec";

  const ZONES = [
    "INFRAPÔLE BRETAGNE","INFRAPÔLE PAYS DE LOIRE","INFRAPÔLE INDRE LIMOUSIN","INFRAPÔLE AQUITAINE","INFRAPÔLE CENTRE","INFRAPÔLE LGV ATLANTIQUE","INFRAPÔLE POITOU CHARENTES",
    "INFRAPÔLE MIDI-PYRÉNÉES","INFRAPÔLE LANGUEDOC-ROUSSILLON","INFRAPÔLE PACA","INFRAPÔLE LGV SEE","INFRAPÔLE ALPES","INFRAPÔLE RHODANIEN","INFRAPÔLE AUVERGNE-NIVERNAIS",
    "INFRAPÔLE BOURGOGNE FRANCHE-COMTÉ","INFRAPÔLE RHENAN","INFRAPÔLE EST EUROPÉEN","INFRAPÔLE LORRAINE","INFRAPÔLE CHAMPAGNE ARDENNE",
    "INFRAPÔLE HAUTE PICARDIE","INFRAPÔLE NORD EUROPÉEN","INFRAPÔLE NORD PAS DE CALAIS","INFRAPÔLE NORD NORMANDIE"
  ];

  // ====== DOM ======
  const app = document.getElementById("app");
  const gate = document.getElementById("gate");
  const pwInput = document.getElementById("pwInput");
  const pwBtn = document.getElementById("pwBtn");
  const pwErr = document.getElementById("pwErr");

  const zoneSelect = document.getElementById("zoneSelect");
  const refreshBtn = document.getElementById("refreshBtn");
  const resultsList = document.getElementById("resultsList");
  const zoneTitle = document.getElementById("zoneTitle");
  const zoneMeta = document.getElementById("zoneMeta");

  const backdrop = document.getElementById("backdrop");
  const modalZone = document.getElementById("modalZone");
  const closeModal = document.getElementById("closeModal");
  const cancelModal = document.getElementById("cancelModal");
  const saveModal = document.getElementById("saveModal");
  const modalErr = document.getElementById("modalErr");
  const mEquipe = document.getElementById("mEquipe");
  const mAgent = document.getElementById("mAgent");
  const mEncad = document.getElementById("mEncad");

  // ====== STATE ======
  let API = { rows: [], byZone: {} };

  // ====== JSONP API (stable sur GitHub Pages) ======
  function apiCall(action, params = {}) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + action + "_" + Date.now() + "_" + Math.floor(Math.random()*10000);
      window[cb] = (payload) => {
        try { delete window[cb]; } catch(e){}
        script.remove();
        resolve(payload);
      };
      const usp = new URLSearchParams({ action, callback: cb, t: Date.now(), ...params });
      const url = `${SCRIPT_URL}?${usp.toString()}`;
      const script = document.createElement("script");
      script.src = url;
      script.onerror = () => {
        try { delete window[cb]; } catch(e){}
        script.remove();
        reject(new Error("Impossible de charger les données (API). Vérifie Apps Script (doGet action=list) et le déploiement."));
      };
      document.head.appendChild(script);
    });
  }

  const round1 = n => Math.round(n * 10) / 10;
  const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const escAttr = s => esc(s).replace(/"/g, "&quot;");

  function zoneStats(zone){
    const z = (API && API.byZone) ? API.byZone[zone] : null;
    if (!z || !z.count) return {count:0,moyA:0,moyE:0};
    return {count:z.count, moyA:round1(z.sumA/z.count), moyE:round1(z.sumE/z.count)};
  }

  function renderZone(zone){
    zoneTitle.textContent = zone;
    const st = zoneStats(zone);
    zoneMeta.textContent = `${st.count} équipe(s) – Moy ${st.moyA}% A / ${st.moyE}% E`;

    const rows = (API && Array.isArray(API.rows)) ? API.rows.filter(r => r.zone === zone) : [];
    resultsList.innerHTML = "";

    if (!rows.length){
      resultsList.innerHTML = `<div class="small" style="color:var(--muted)">Aucune équipe ici. Clique sur la zone sur la carte pour ajouter.</div>`;
      return;
    }

    rows.forEach(r => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="cardTop">
          <div>
            <div class="teamName">${esc(r.equipe)}</div>
            <div class="small">ID: ${esc(r.id)}</div>
          </div>
          <div class="small">${esc(r.zone)}</div>
        </div>

        <div class="grid">
          <div>
            <div class="small">Nom équipe</div>
            <input data-id="${escAttr(r.id)}" data-field="equipe" value="${escAttr(r.equipe)}">
          </div>
          <div>
            <div class="small">% agent</div>
            <input type="number" min="0" max="100" step="1" data-id="${escAttr(r.id)}" data-field="agent" value="${r.agent}">
          </div>
          <div>
            <div class="small">% encadrement</div>
            <input type="number" min="0" max="100" step="1" data-id="${escAttr(r.id)}" data-field="encad" value="${r.encad}">
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-accent btn-sm" data-action="update" data-id="${escAttr(r.id)}">Modifier</button>
          <button class="btn btn-danger btn-sm" data-action="delete" data-id="${escAttr(r.id)}">Supprimer</button>
        </div>
      `;
      resultsList.appendChild(card);
    });
  }

  async function loadAll(){
    try{
      const res = await apiCall("list");
      if(!res || res.ok !== true) throw new Error((res && res.error) ? res.error : "Réponse API invalide");
      if(!res.data || !Array.isArray(res.data.rows)) throw new Error("Format API invalide: data.rows manquant");

      API = res.data; // {rows, byZone}
      renderZone(zoneSelect.value || ZONES[0]);
    }catch(err){
      console.error(err);
      resultsList.innerHTML = `<div class="small" style="color:var(--danger);font-weight:900">${esc(err.message || err)}</div>`;
      zoneTitle.textContent = "";
      zoneMeta.textContent = "";
    }
  }

  // ====== Panel events ======
  zoneSelect.addEventListener("change", () => renderZone(zoneSelect.value));
  refreshBtn.addEventListener("click", loadAll);

  resultsList.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if(!btn) return;

    const id = btn.getAttribute("data-id");
    const action = btn.getAttribute("data-action");
    const card = btn.closest(".card");
    const inputs = Array.from(card.querySelectorAll("input[data-id]"));

    const data = {};
    inputs.forEach(inp => data[inp.getAttribute("data-field")] = inp.value);

    try{
      if(action === "update"){
        const equipe = String(data.equipe||"").trim();
        const agent = Number(data.agent);
        const encad = Number(data.encad);
        if(!equipe) return alert("Nom équipe obligatoire");
        if(isNaN(agent) || isNaN(encad)) return alert("Pourcentages invalides");
        const res = await apiCall("update", { id, equipe, agent, encad });
        if(!res.ok) throw new Error(res.error || "update failed");
        API = res.data;
        renderZone(zoneSelect.value);
      }

      if(action === "delete"){
        if(!confirm("Supprimer cette ligne ?")) return;
        const res = await apiCall("delete", { id });
        if(!res.ok) throw new Error(res.error || "delete failed");
        API = res.data;
        renderZone(zoneSelect.value);
      }
    }catch(err){
      console.error(err);
      alert("Erreur: " + (err.message || err));
    }
  });

  // ====== Modal add ======
  function openModal(zone){
    modalZone.textContent = zone;
    mEquipe.value = ""; mAgent.value = ""; mEncad.value = "";
    modalErr.style.display = "none";
    backdrop.style.display = "flex";
    setTimeout(()=>mEquipe.focus(), 50);
  }
  function closeModalFn(){ backdrop.style.display="none"; }
  closeModal.addEventListener("click", closeModalFn);
  cancelModal.addEventListener("click", closeModalFn);
  backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) closeModalFn(); });

  saveModal.addEventListener("click", async () => {
    const zone = modalZone.textContent;
    const equipe = mEquipe.value.trim();
    const agent = Number(mAgent.value);
    const encad = Number(mEncad.value);

    if(!equipe){ modalErr.textContent="Merci de saisir le nom d’équipe."; modalErr.style.display="block"; return; }
    if(isNaN(agent) || isNaN(encad)){ modalErr.textContent="Merci de saisir les deux pourcentages (0-100)."; modalErr.style.display="block"; return; }

    try{
      const res = await apiCall("add", { zone, equipe, agent, encad });
      if(!res.ok) throw new Error(res.error || "add failed");
      API = res.data;
      renderZone(zoneSelect.value);
      closeModalFn();
    }catch(err){
      console.error(err);
      modalErr.textContent = "Erreur API: " + (err.message || err);
      modalErr.style.display = "block";
    }
  });

  document.querySelectorAll(".hotspot").forEach(h => {
    h.addEventListener("click", () => {
      const z = h.getAttribute("data-zone");
      zoneSelect.value = z;
      renderZone(z);
      openModal(z);
    });
  });

  // ====== Password gate ======
  function unlock(){
    gate.style.display = "none";
    app.style.display = "grid";
    loadAll();
  }

  function checkPw(){
    const v = pwInput.value;
    if(v === PASSWORD){
      sessionStorage.setItem("cts_carte_ok", "1");
      unlock();
    }else{
      pwErr.textContent = "Mot de passe incorrect.";
      pwErr.style.display = "block";
    }
  }
  pwBtn.addEventListener("click", checkPw);
  pwInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") checkPw(); });

  // init select
  zoneSelect.innerHTML = "";
  ZONES.forEach(z => {
    const opt = document.createElement("option");
    opt.value = z; opt.textContent = z;
    zoneSelect.appendChild(opt);
  });
  zoneSelect.value = "INFRAPÔLE BRETAGNE";

  // auto unlock if session ok
  if(sessionStorage.getItem("cts_carte_ok")==="1") unlock();
</script>
</body>
</html>